<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pyramiding Risk Manager</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121824">
  <meta name="description" content="Calculate pyramiding positions with capped risk for both long and short trades">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root { --bg:#0b0f14; --card:#121824; --muted:#9fb0c3; --text:#e7eef7; --accent:#4dd8a3; --danger:#ff5d6c; --line:#1e2a3a; --tab-active:#1e2a3a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:100%;margin:0 auto;padding:12px 10px 30px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;padding:0 5px}
    h1{font-size:18px;margin:6px 0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:10px;box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    @media (min-width:380px){ .grid{grid-template-columns:1fr 1fr} }
    @media (min-width:520px){ .grid{grid-template-columns:1fr 1fr 1fr} }
    label{font-size:11px;color:var(--muted);display:block;margin-bottom:5px}
    input[type="number"], input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--text);font-size:14px}
    input::placeholder{color:#6b7c90;font-size:13px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:600;background:#1b2533;color:var(--text);cursor:pointer;font-size:13px;flex:1}
    .btn:hover{filter:brightness(1.1)}
    .btn-accent{background:var(--accent);color:#012916}
    .btn-danger{background:var(--danger);color:#19030a}
    .btn-short{background:var(--danger);color:#19030a}
    .btn-small{padding:8px 10px;font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:3px 6px;border-radius:8px;background:#0b1320;border:1px solid var(--line);font-size:11px}
    table{width:100%;border-collapse:collapse;margin-top:6px;font-size:12px}
    th,td{padding:8px 6px;border-bottom:1px dashed var(--line);text-align:right;font-variant-numeric:tabular-nums}
    th:first-child, td:first-child{text-align:left}
    tfoot td{border-top:1px solid var(--line);font-weight:700;padding-top:10px}
    .right{float:right}
    .note{font-size:11px;color:var(--muted);line-height:1.4}
    .ok{color:var(--accent)}
    .bad{color:var(--danger)}
    .sticky{position:sticky;bottom:0;backdrop-filter:blur(8px);background:linear-gradient(180deg, rgba(11,15,20,0), var(--bg));padding-top:10px;margin-top:6px}
    .direction-long { color: var(--accent); }
    .direction-short { color: var(--danger); }
    
    /* Tabs styling */
    .tabs-container{position:relative;margin-bottom:10px}
    .tabs{display:flex;gap:6px;overflow-x:auto;padding-bottom:3px;scrollbar-width:none;-ms-overflow-style:none}
    .tabs::-webkit-scrollbar{display:none}
    .tab{padding:6px 12px;border-radius:10px;background:var(--card);border:1px solid var(--line);cursor:pointer;white-space:nowrap;font-size:12px;flex-shrink:0}
    .tab.active{background:var(--tab-active);border-color:var(--accent)}
    .tab-add{padding:6px 10px;background:var(--accent);color:#012916;font-weight:bold;flex-shrink:0;font-size:14px}
    
    /* Script name input */
    .script-name-container{margin-bottom:10px}
    .script-name-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--text);font-size:14px}
    
    /* Loading indicator */
    .loading{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000}
    
    /* Quantity input section */
    .quantity-section{margin-bottom:12px;padding:10px;background:var(--card);border-radius:10px;border:1px solid var(--line)}
    .quantity-input{font-size:16px;font-weight:600;text-align:center}
    
    /* Entry cards */
    .entry-card{background:#0f1520;border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:8px}
    .entry-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .entry-title{font-size:12px;font-weight:600;color:var(--muted)}
    .entry-values{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .entry-value{font-size:11px}
    .entry-value strong{color:var(--text);font-weight:600}
    
    /* Profit indicators */
    .profit-badge{padding:2px 6px;border-radius:8px;font-size:10px;font-weight:600}
    .profit-positive{background:var(--accent);color:#012916}
    .profit-negative{background:var(--danger);color:#19030a}
  </style>
</head>
<body>
  <div id="loading" class="loading">Loading...</div>
  
  <div class="wrap" id="mainContent" style="display:none">
    <div class="header">
      <h1>ðŸ“ˆ Risk Manager</h1>
      <span class="pill">Mobile â€¢ PWA</span>
    </div>

    <div class="tabs-container">
      <div class="tabs" id="tabsContainer"></div>
    </div>

    <div class="card">
      <div class="script-name-container">
        <input type="text" id="scriptName" class="script-name-input" placeholder="Script name (RELIANCE, INFY)" />
      </div>
      
      <div class="row" style="justify-content: center; margin-bottom: 10px;">
        <button id="tradeDirection" class="btn" style="min-width:100px">
          Long â–²
        </button>
      </div>
      
      <div class="grid">
        <div>
          <label>Currency</label>
          <input id="currency" type="text" value="â‚¹" maxlength="3" />
        </div>
        <div>
          <label>Max Risk (â‚¹)</label>
          <input id="risk" type="number" inputmode="decimal" value="1000" min="1" />
        </div>
        <div>
          <label>Current Price</label>
          <input id="currentPrice" type="number" inputmode="decimal" placeholder="Live price" />
        </div>
      </div>
      
      <div class="quantity-section">
        <label>Total Quantity to Distribute</label>
        <input id="totalQuantity" type="number" inputmode="numeric" placeholder="Enter total shares" class="quantity-input" />
        <div class="note" style="margin-top:6px">
          Auto-distributed: 4X + 2X + 2X + 1X + 1X (10X total)
        </div>
      </div>

      <div class="row" style="justify-content:space-between;gap:6px;margin-top:10px">
        <button class="btn btn-accent btn-small" id="distributeBtn">Auto Distribute</button>
        <button class="btn btn-small" id="addSample">Sample Data</button>
        <button class="btn btn-danger btn-small" id="reset">Reset All</button>
      </div>
    </div>

    <div class="card">
      <div class="entry-header">
        <div class="entry-title">ENTRIES</div>
        <div class="muted">Click to edit prices</div>
      </div>
      <div id="entriesContainer"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div>
          <div class="muted">Summary</div>
          <div id="summaryLine" style="font-weight:700;margin-top:4px;font-size:13px"></div>
        </div>
        <div style="text-align:right">
          <div class="muted">Stoploss</div>
          <div id="combinedSL" style="font-size:20px;font-weight:800"></div>
        </div>
      </div>

      <div style="overflow-x:auto">
        <table id="table">
          <thead>
            <tr>
              <th>Entry</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Value</th>
              <th>Avg</th>
              <th>SL</th>
              <th>P&L @Level</th>
              <th>P&L @Now</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="8" id="foot"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="sticky">
        <div class="note">
          SL = Avg Â± (Risk / Total Qty). P&L @Level shows cumulative profit at that entry price.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'pyramidingRiskManager';
  const DEFAULT_STATE = {
    entries: [],
    isLong: true,
    currency: 'â‚¹',
    risk: 1000,
    currentPrice: '',
    scriptName: 'NIFTY',
    totalQuantity: 0
  };

  const DISTRIBUTION_RATIOS = [4, 2, 2, 1, 1]; // 4X + 2X + 2X + 1X + 1X = 10X
  const TOTAL_RATIO = DISTRIBUTION_RATIOS.reduce((sum, ratio) => sum + ratio, 0);

  const els = {
    currency: document.getElementById('currency'),
    risk: document.getElementById('risk'),
    currentPrice: document.getElementById('currentPrice'),
    scriptName: document.getElementById('scriptName'),
    totalQuantity: document.getElementById('totalQuantity'),
    distributeBtn: document.getElementById('distributeBtn'),
    addSample: document.getElementById('addSample'),
    reset: document.getElementById('reset'),
    tradeDirection: document.getElementById('tradeDirection'),
    entriesContainer: document.getElementById('entriesContainer'),
    tbody: document.getElementById('tbody'),
    combinedSL: document.getElementById('combinedSL'),
    summaryLine: document.getElementById('summaryLine'),
    foot: document.getElementById('foot'),
    tabsContainer: document.getElementById('tabsContainer'),
    loading: document.getElementById('loading'),
    mainContent: document.getElementById('mainContent')
  };

  let state = {...DEFAULT_STATE};
  let tabs = {};
  let currentTab = 'tab1';

  // Safe localStorage functions
  function safeSetItem(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      console.error('localStorage set failed:', e);
      return false;
    }
  }

  function safeGetItem(key) {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (e) {
      console.error('localStorage get failed:', e);
      return null;
    }
  }

  // Initialize tabs
  function initTabs() {
    const savedTabs = safeGetItem(STORAGE_KEY + '_tabs');
    if (savedTabs && Object.keys(savedTabs).length > 0) {
      tabs = savedTabs;
      renderTabs();
      const lastActiveTab = safeGetItem(STORAGE_KEY + '_activeTab');
      const firstTab = Object.keys(tabs)[0];
      switchTab(lastActiveTab && tabs[lastActiveTab] ? lastActiveTab : firstTab);
    } else {
      createDefaultTab();
    }
    showContent();
  }

  function showContent() {
    els.loading.style.display = 'none';
    els.mainContent.style.display = 'block';
  }

  function createDefaultTab() {
    tabs = { tab1: {...DEFAULT_STATE, scriptName: 'NIFTY'} };
    safeSetItem(STORAGE_KEY + '_tabs', tabs);
    safeSetItem(STORAGE_KEY + '_activeTab', 'tab1');
    renderTabs();
    switchTab('tab1');
  }

  function renderTabs() {
    els.tabsContainer.innerHTML = '';
    Object.keys(tabs).forEach(tabId => {
      const tab = document.createElement('div');
      tab.className = `tab ${tabId === currentTab ? 'active' : ''}`;
      tab.textContent = tabs[tabId].scriptName || `Tab ${tabId}`;
      tab.setAttribute('data-tab', tabId);
      tab.addEventListener('click', () => switchTab(tabId));
      els.tabsContainer.appendChild(tab);
    });
    
    const addBtn = document.createElement('div');
    addBtn.className = 'tab tab-add';
    addBtn.textContent = '+';
    addBtn.addEventListener('click', addNewTab);
    els.tabsContainer.appendChild(addBtn);
  }

  function addNewTab() {
    const tabId = 'tab' + (Object.keys(tabs).length + 1);
    tabs[tabId] = {...DEFAULT_STATE, scriptName: `SCRIPT ${Object.keys(tabs).length + 1}`};
    saveTabs();
    renderTabs();
    switchTab(tabId);
  }

  function switchTab(tabId) {
    if (!tabs[tabId]) tabId = Object.keys(tabs)[0] || 'tab1';
    saveCurrentTabState();
    currentTab = tabId;
    state = {...tabs[tabId]};
    
    els.currency.value = state.currency || 'â‚¹';
    els.risk.value = state.risk || 1000;
    els.currentPrice.value = state.currentPrice || '';
    els.scriptName.value = state.scriptName || 'NIFTY';
    els.totalQuantity.value = state.totalQuantity || '';
    
    renderEntries();
    updateDirectionButton();
    compute();
    renderTabs();
    safeSetItem(STORAGE_KEY + '_activeTab', currentTab);
  }

  function saveCurrentTabState() {
    if (!currentTab || !tabs[currentTab]) return;
    
    state.currency = els.currency.value;
    state.risk = Number(els.risk.value) || 1000;
    state.currentPrice = els.currentPrice.value;
    state.scriptName = els.scriptName.value;
    state.totalQuantity = Number(els.totalQuantity.value) || 0;
    
    tabs[currentTab] = {...state};
    saveTabs();
  }

  function saveTabs() {
    safeSetItem(STORAGE_KEY + '_tabs', tabs);
  }

  function distributeQuantities() {
    const totalQty = Number(els.totalQuantity.value);
    if (!totalQty || totalQty <= 0) {
      alert('Please enter a valid total quantity');
      return;
    }

    const unitSize = totalQty / TOTAL_RATIO;
    state.entries = DISTRIBUTION_RATIOS.map(ratio => ({
      quantity: Math.round(ratio * unitSize),
      price: 0
    }));

    renderEntries();
    compute();
    saveCurrentTabState();
  }

  function renderEntries() {
    els.entriesContainer.innerHTML = '';
    state.entries.forEach((entry, index) => {
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry-card';
      const entryValue = entry.price && entry.quantity ? entry.quantity * entry.price : 0;
      
      entryDiv.innerHTML = `
        <div class="entry-header">
          <div class="entry-title">ENTRY #${index + 1}</div>
          <div class="muted">${fmt(entry.quantity)} shares</div>
        </div>
        <div class="entry-values">
          <div class="entry-value">
            <span class="muted">Price: </span>
            <input type="number" class="entry-price" placeholder="Enter price" 
                   value="${entry.price || ''}" data-index="${index}" 
                   inputmode="decimal" step="0.01" min="0.01"
                   style="width:80px;padding:4px 6px;font-size:12px;border-radius:6px;border:1px solid var(--line);background:#0a101a">
          </div>
          <div class="entry-value">
            <span class="muted">Value: </span>
            <strong>${entryValue ? cur(entryValue) : 'â€”'}</strong>
          </div>
        </div>
      `;
      els.entriesContainer.appendChild(entryDiv);
    });

    // Add event listeners to price inputs
    setTimeout(() => {
      document.querySelectorAll('.entry-price').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          const price = parseFloat(e.target.value) || 0;
          if (state.entries[index]) {
            state.entries[index].price = price;
            
            // Update the value display
            const entryValue = state.entries[index].quantity * price;
            const valueElement = e.target.closest('.entry-card').querySelector('.entry-value strong');
            if (valueElement) {
              valueElement.textContent = cur(entryValue);
            }
            
            compute();
            saveCurrentTabState();
          }
        });
      });
    }, 100);
  }

  function fmt(n) {
    if (isNaN(n) || !isFinite(n)) return 'â€”';
    return Number(n).toLocaleString(undefined, {maximumFractionDigits: 0});
  }

  function cur(n) {
    const c = els.currency.value || 'â‚¹';
    if (isNaN(n) || !isFinite(n)) return 'â€”';
    return c + ' ' + Number(n).toLocaleString(undefined, {maximumFractionDigits: 2});
  }

  function toggleTradeDirection() {
    state.isLong = !state.isLong;
    updateDirectionButton();
    compute();
    saveCurrentTabState();
  }

  function updateDirectionButton() {
    els.tradeDirection.textContent = state.isLong ? 'Long â–²' : 'Short â–¼';
    els.tradeDirection.classList.toggle('btn-accent', state.isLong);
    els.tradeDirection.classList.toggle('btn-short', !state.isLong);
  }

  function compute() {
    const risk = Math.max(0, Number(els.risk.value) || 0);
    const cpx = els.currentPrice.value === '' ? NaN : Number(els.currentPrice.value);

    let rows = '';
    let cumQty = 0;
    let totalCost = 0;
    let combinedSL = NaN;
    let lastValidIdx = -1;

    state.entries.forEach((entry, idx) => {
      const { quantity, price } = entry;
      if (!quantity || !price || price <= 0) {
        rows += `<tr><td>#${idx + 1}</td><td colspan="7" class="muted">Enter price</td></tr>`;
        return;
      }

      const entryValue = quantity * price;
      cumQty += quantity;
      totalCost += entryValue;
      const avgCost = totalCost / cumQty;
      
      const sl = state.isLong 
        ? avgCost - (risk / cumQty)
        : avgCost + (risk / cumQty);
      
      combinedSL = sl;
      lastValidIdx = idx;

      // Calculate cumulative P&L at this entry's price (P&L @Level)
      const pnlAtLevel = state.isLong
        ? (price - avgCost) * cumQty
        : (avgCost - price) * cumQty;

      // Calculate P&L at current market price (P&L @Now)
      const pnlAtNow = isFinite(cpx) 
        ? state.isLong 
          ? (cpx - avgCost) * cumQty
          : (avgCost - cpx) * cumQty
        : NaN;

      const slClass = state.isLong ? 'direction-long' : 'direction-short';
      const pnlNowClass = pnlAtNow >= 0 ? 'ok' : 'bad';
      const pnlLevelClass = pnlAtLevel >= 0 ? 'ok' : 'bad';
      
      rows += `<tr>
        <td>#${idx + 1}</td>
        <td>${fmt(quantity)}</td>
        <td>${cur(price)}</td>
        <td>${cur(entryValue)}</td>
        <td>${cur(avgCost)}</td>
        <td class="${slClass}">${cur(sl)}</td>
        <td class="${pnlLevelClass}">${cur(pnlAtLevel)}</td>
        <td class="${pnlNowClass}">${isFinite(cpx) ? cur(pnlAtNow) : 'â€”'}</td>
      </tr>`;
    });

    els.tbody.innerHTML = rows || `<tr><td colspan="8" class="muted" style="text-align:center;padding:12px">Enter prices to see calculations</td></tr>`;

    if (lastValidIdx >= 0) {
      const avgFinal = totalCost / cumQty;
      const totalValue = totalCost;
      const directionText = state.isLong ? 'long' : 'short';
      
      const txt = `${lastValidIdx + 1} entries, ${fmt(cumQty)} shares, Avg ${cur(avgFinal)}`;
      els.summaryLine.textContent = txt;
      
      els.combinedSL.className = state.isLong ? 'direction-long' : 'direction-short';
      els.combinedSL.textContent = cur(combinedSL);
      
      const totalPnl = isFinite(cpx) ? (state.isLong ? (cpx - avgFinal) * cumQty : (avgFinal - cpx) * cumQty) : 0;
      const pnlText = isFinite(cpx) ? ` â€¢ P&L: ${cur(totalPnl)}` : '';
      
      els.foot.innerHTML = `Total: ${cur(totalValue)} â€¢ Risk: ${cur(risk)}${pnlText}`;
    } else {
      els.summaryLine.textContent = 'Enter prices to start';
      els.combinedSL.textContent = 'â€”';
      els.foot.textContent = '';
    }
  }

  // Event Listeners
  els.distributeBtn.addEventListener('click', distributeQuantities);
  
  els.addSample.addEventListener('click', () => {
    els.totalQuantity.value = 500;
    distributeQuantities();
    // Set sample prices after a delay to ensure inputs are rendered
    setTimeout(() => {
      const samplePrices = [100, 104, 108, 112, 116];
      samplePrices.forEach((price, index) => {
        if (state.entries[index]) {
          state.entries[index].price = price;
          const input = document.querySelector(`.entry-price[data-index="${index}"]`);
          if (input) input.value = price;
          
          // Update the value display
          const entryValue = state.entries[index].quantity * price;
          const valueElement = input.closest('.entry-card').querySelector('.entry-value strong');
          if (valueElement) {
            valueElement.textContent = cur(entryValue);
          }
        }
      });
      compute();
      saveCurrentTabState();
    }, 200);
  });

  els.reset.addEventListener('click', () => {
    if (confirm('Reset all data?')) {
      state.entries = [];
      els.totalQuantity.value = '';
      els.currentPrice.value = '';
      renderEntries();
      compute();
      saveCurrentTabState();
    }
  });

  els.tradeDirection.addEventListener('click', toggleTradeDirection);

  ['risk', 'currency', 'currentPrice', 'scriptName', 'totalQuantity'].forEach(id => {
    els[id].addEventListener('input', () => {
      compute();
      saveCurrentTabState();
      if (id === 'scriptName') renderTabs();
    });
  });

  // Initialize
  setTimeout(initTabs, 100);
})();

// PWA Service Worker
if ("serviceWorker" in navigator) {
  window.addEventListener('load', () => {
    if (window.location.pathname === '/' && !window.location.search.includes('pwa')) {
      window.location.href = '/Pyramiding-Risk-Manager/';
    } else {
      navigator.serviceWorker.register('/Pyramiding-Risk-Manager/sw.js', {
        scope: '/Pyramiding-Risk-Manager/'
      }).catch(console.error);
    }
  });
}
</script>
</body>
</html>